#!/usr/bin/env bash

set -o errexit -o nounset

GIT_ROOT=${GIT_ROOT:-$(git rev-parse --show-toplevel)}
cd "${GIT_ROOT}"
source .envrc

if test "${1:-}" = "helm" ; then
    CREATE_HELM_CHART=true
    BUILD_TARGET=helm
    export FISSILE_OUTPUT_DIR="${FISSILE_OUTPUT_DIR:-${PWD}}/${BUILD_TARGET}/cf"
else
    CREATE_HELM_CHART=false
    BUILD_TARGET=kube
    # Overrides when generating kube config files instead of helm charts.
    ENV_FILES="$(echo bin/settings/*.env bin/settings/kube/*.env)"
    export FISSILE_DEFAULTS_FILE="$(echo "${ENV_FILES}" | tr ' ' ,)"
    export FISSILE_OUTPUT_DIR="${FISSILE_OUTPUT_DIR:-${PWD}}/${BUILD_TARGET}"
fi

rm -rf "${FISSILE_OUTPUT_DIR}"

fissile build "${BUILD_TARGET}"

# This is a small hack to make the output of make kube be compatible with K8s 1.6
jobs=($(grep -rl "kind: Job" "${FISSILE_OUTPUT_DIR}"))
if test "${#jobs[@]}" -gt 0; then
    perl -p -i -e 's@extensions/v1beta1@batch/v1@' "${jobs[@]}"
fi
