#!/usr/bin/env bash

set -o errexit -o nounset

GIT_ROOT=${GIT_ROOT:-$(git rev-parse --show-toplevel)}
cd "${GIT_ROOT}"
NAMESPACE="cf"
UAA_NAMESPACE="uaa"
CA_CERT=internal-ca-cert

has_namespace() {
    kubectl get namespace --output=name "${NAMESPACE}" >/dev/null 2>/dev/null
}

get_uaa_secret_name() {
    kubectl get pod mysql-0 --namespace "${UAA_NAMESPACE}" \
            -o jsonpath='{@.spec.containers[0].env[?(@.name=="MONIT_PASSWORD")].valueFrom.secretKeyRef.name}'
}

get_uaa_secret () {
    kubectl get secret $(get_uaa_secret_name) --namespace "${UAA_NAMESPACE}" -o jsonpath="{.data['$1']}"
}

has_internal_ca() {
    test "$(get_uaa_secret ${CA_CERT})" != ""
}

stampy "${GIT_ROOT}/scf_metrics.csv" "$0" make-run start

stampy "${GIT_ROOT}/scf_metrics.csv" "$0" make-run::namespace start
if has_namespace ; then
    kubectl delete namespace "${NAMESPACE}"
fi

printf "Waiting for namespace %s to be deleted...\n" "${NAMESPACE}"
while has_namespace ; do
    sleep 1
done

kubectl create namespace "${NAMESPACE}"
stampy "${GIT_ROOT}/scf_metrics.csv" "$0" make-run::namespace end

stampy "${GIT_ROOT}/scf_metrics.csv" "$0" make-run::ca-cert start

printf "Waiting for $CA_CERT to be generated by the uaa chart...\n"
until has_internal_ca ; do
    sleep 1
done

CA_CERT="$(get_uaa_secret ${CA_CERT} | base64 -d -)"

stampy "${GIT_ROOT}/scf_metrics.csv" "$0" make-run::ca-cert end

stampy "${GIT_ROOT}/scf_metrics.csv" "$0" make-run::create start

kubectl get storageclass persistent 2>/dev/null || {
    perl -p -e 's@storage.k8s.io/v1beta1@storage.k8s.io/v1@g' \
        "${GIT_ROOT}/src/uaa-fissile-release/kube-test/storage-class-host-path.yml" | \
    kubectl create -f -
}

DOMAIN=${DOMAIN:-}
NETWORK_ENV=bin/settings/network.env
if test -n "${DOMAIN}"; then
    TMP=$(mktemp -d)
    cp "${NETWORK_ENV}" "${TMP}"
    trap "rm -rf ${TMP}" EXIT
    NETWORK_ENV="${TMP}/$(basename "${NETWORK_ENV}")"
    sed -e "s/^DOMAIN=.*/DOMAIN=${DOMAIN}/" \
        -e "s/^TCP_DOMAIN=.*/TCP_DOMAIN=tcp.${DOMAIN}/" \
        -i "${NETWORK_ENV}"
fi
source bin/settings/settings.env
source "${NETWORK_ENV}"

# The extra IP address for `kube.external_ips` is to ensure that we can
# create services binding to multiple addresses correctly.  It points at
# an address that shouldn't exist in real life.
helm install output/helm \
     --namespace ${NAMESPACE} \
     --set "env.DOMAIN=${DOMAIN}" \
     --set "env.TCP_DOMAIN=${TCP_DOMAIN}" \
     --set "env.UAA_PORT=${UAA_PORT}" \
     --set "secrets.CLUSTER_ADMIN_PASSWORD=$CLUSTER_ADMIN_PASSWORD" \
     --set "secrets.UAA_ADMIN_CLIENT_SECRET=${UAA_ADMIN_CLIENT_SECRET}" \
     --set "secrets.UAA_CA_CERT=${CA_CERT}" \
     --set "kube.external_ips[0]=192.0.2.42" \
     --set "kube.external_ips[1]=$(dig +short ${DOMAIN})" \
     "$@"

stampy "${GIT_ROOT}/scf_metrics.csv" "$0" make-run::create end

stampy "${GIT_ROOT}/scf_metrics.csv" "$0" make-run 'done'
